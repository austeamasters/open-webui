services:
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    volumes:
      - open-webui:/app/backend/data
    environment:
      - WEBUI_SECRET_KEY=your-secret-key-change-this
      - ENABLE_OLLAMA_API=false
      - ENABLE_OPENAI_API=true
      - OPENAI_API_BASE_URL=https://api.openai.com/v1
      - OPENAI_API_KEY=
      - ENABLE_ANTHROPIC_API=true
      - ANTHROPIC_API_BASE_URL=https://api.anthropic.com
      - ANTHROPIC_API_KEY=
      - ENABLE_CUSTOM_API=true
      - PORT=8080
      - ENABLE_WEBSOCKET_SUPPORT=true
      - WEBSOCKET_MANAGER=memory
      - WEBUI_URL=https://openwebui.australianteamasters.com.au
      # Force longer timeouts to prevent Bad Gateway
      - AIOHTTP_CLIENT_TIMEOUT=0
      - REQUEST_TIMEOUT=0
    extra_hosts:
      - host.docker.internal:host-gateway
    restart: unless-stopped
    networks:
      - dokploy-network
    labels:
      - traefik.enable=true
      - traefik.docker.network=dokploy-network
      
      # HTTPS Router
      - traefik.http.routers.openwebui.rule=Host(`openwebui.australianteamasters.com.au`)
      - traefik.http.routers.openwebui.entrypoints=websecure
      - traefik.http.routers.openwebui.tls.certresolver=letsencrypt
      - traefik.http.routers.openwebui.service=openwebui
      - traefik.http.routers.openwebui.middlewares=openwebui-headers
      
      # HTTP Router (redirect)
      - traefik.http.routers.openwebui-http.rule=Host(`openwebui.australianteamasters.com.au`)
      - traefik.http.routers.openwebui-http.entrypoints=web
      - traefik.http.routers.openwebui-http.middlewares=redirect-to-https
      
      # Service with aggressive timeout overrides
      - traefik.http.services.openwebui.loadbalancer.server.port=8080
      - traefik.http.services.openwebui.loadbalancer.passhostheader=true
      - traefik.http.services.openwebui.loadbalancer.responseforwarding.flushinterval=1ms
      
      # Middlewares
      - traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https
      - traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true
      
      # Headers to fix streaming/WebSocket issues
      - traefik.http.middlewares.openwebui-headers.headers.customrequestheaders.X-Forwarded-Proto=https
      - traefik.http.middlewares.openwebui-headers.headers.customrequestheaders.X-Real-IP=
      - traefik.http.middlewares.openwebui-headers.headers.customrequestheaders.X-Forwarded-For=
      - traefik.http.middlewares.openwebui-headers.headers.customrequestheaders.Host=
      - traefik.http.middlewares.openwebui-headers.headers.customrequestheaders.Connection=
      - traefik.http.middlewares.openwebui-headers.headers.customrequestheaders.Upgrade=

volumes:
  open-webui: {}

networks:
  dokploy-network:
    external: true
